# Архитектура Grid Trading Bot для Bybit (MVP v1.0)

## 1. Обзор проекта

Данный проект представляет собой симуляционный Grid Trading Bot, разработанный на [`Python 3.12`](#), нацеленный на торговлю бессрочными фьючерсами [`BTCUSDT`](#) на бирже [`Bybit`](#). Основной функционал MVP сфокусирован на проведении бэктестинга заданной сетчатой стратегии с использованием исторических данных (1 год, 15м таймфрейм). Настройка параметров и запуск симуляции осуществляется через [`Streamlit`](#) веб-интерфейс. Зависимости управляются через [`python-dotenv`](#) и перечислены в [`requirements.txt`](#).

## 2. Структура директорий

Предлагаемая структура проекта:

```
.
├── config/
│   └── settings.py         # Хранение настроек по умолчанию
├── models/
│   ├── grid_strategy.py    # Логика расчета уровней сетки
│   └── exchange_api.py     # Обертка для ccxt и работы с API Bybit
├── services/
│   ├── backtester.py       # Ядро симуляции и расчета метрик
│   └── data_loader.py      # Получение и предобработка данных
├── web_ui/
│   └── app.py              # Главный файл Streamlit приложения
├── .env                    # Секретные ключи и переменные окружения
├── requirements.txt        # Зависимости проекта
└── ARCHITECTURE.md         # Данный файл
```

## 3. Компоненты системы (классы, функции)

### Модуль `models`

-   **`models/exchange_api.py`**:
    -   `ExchangeAPI`: Класс-обертка над [`ccxt`](#).
        -   `__init__(use_testnet=True)`: Инициализация клиента `ccxt.bybit` с использованием конфигурации из `config.settings`. Параметр `use_testnet` определяет, использовать тестовую или основную сеть Bybit.
        -   `fetch_ohlcv(symbol, timeframe, since, limit)`: Получение исторических данных OHLCV.
        -   `fetch_historical_data(symbol, timeframe, start_date, end_date)`: Загрузка данных за указанный период с автоматической пагинацией.
        -   `simulate_order_execution(price, side, amount, current_time)`: Симуляция исполнения ордера (для бэктестинга).
        -   `get_symbol_info(symbol)`: Возвращает информацию о торговой паре (точность, лимиты).

-   **`models/grid_strategy.py`**:
    -   `GridStrategy`: Класс для определения сетки.
        -   `__init__(upper_bound, lower_bound, num_levels, amount_per_level, deposit)`: Принимает основные параметры MVP.
        -   `calculate_levels(current_price)`: Возвращает список объектов `GridLevel` (цена, сторона, объём) для симуляции.
        -   `check_order_execution(current_price, current_time, tolerance)`: Проверяет, какие уровни должны быть исполнены при текущей цене.
        -   `get_statistics()`: Возвращает статистику по сетке (количество исполненных уровней, объёмы и т.д.).
        -   `reset()`: Сброс состояния всех уровней для повторного использования.

### Модуль `services`

-   **`services/data_loader.py`**:
    -   `DataLoader`: Класс для загрузки и управления историческими данными.
        -   `load_historical_data(symbol, timeframe, start_date, end_date, use_cache=True)`: Загружает данные за указанный период с возможностью кэширования.
        -   `load_last_year_data(symbol=None, timeframe=None, use_cache=True)`: Загружает данные за последний год (по умолчанию из конфига).
        -   `preprocess_data(df, fill_missing=True, resample=None)`: Предобработка данных (заполнение пропусков, ресемплирование).
        -   `get_data_statistics(df)`: Возвращает статистику по данным (диапазон цен, объём, пропуски).

-   **`services/backtester.py`**:
    -   `Backtester`: Основной класс симуляции.
        -   `run_backtest(data, strategy, fee_rate=0.0006)`: Основной цикл, итерирующий по данным и применяющий логику стратегии. Возвращает словарь с метриками.
        -   `calculate_metrics()`: Расчет PnL, Win Rate, Max Drawdown, Sharpe Ratio на основе собранных сделок и кривой капитала.
        -   `visualize_equity(save_path=None)`: Генерация графика [`plotly`](#) с кривой капитала и просадкой.
        -   `get_trades_dataframe()`: Возвращает сделки в виде DataFrame.
        -   `get_equity_dataframe()`: Возвращает кривую капитала в виде DataFrame.

### Модуль `web_ui`

-   **`web_ui/app.py`**:
    -   `load_historical_data(symbol, timeframe, days)`: Загружает исторические данные за указанное количество дней.
    -   `run_backtest(data, upper_bound, lower_bound, grid_levels, order_size, initial_balance)`: Запускает бэктест и возвращает результаты.
    -   `display_results(trades_df, metrics, equity_df)`: Отображение таблиц, метрик и графиков.
    -   `main()`: Основная функция Streamlit-приложения, реализующая интерфейс (боковая панель с настройками, кнопки, отображение результатов).

## 4. Поток данных (Диаграмма Mermaid)

```mermaid
graph TD
    A[Пользователь через UI] -->|Ввод параметров| B(web_ui/app.py)
    B -->|Запуск симуляции| C[services/backtester.py:run_backtest]
    C -->|Запрос данных| D(services/data_loader.py)
    D -->|Fetch OHLCV| E[models/exchange_api.py:fetch_ohlcv]
    E -->|Исторические OHLCV| D
    D -->|Очищенный DataFrame| C
    C -->|Расчет уровней сетки| F[models/grid_strategy.py:calculate_levels]
    F -->|Уровни ордеров| C
    C -->|Логирование сделок| G[Журнал сделок]
    C -->|Финальные метрики| H[services/backtester.py:calculate_metrics]
    H -->|Расчет PnL, Sharpe| C
    C -->|Визуализация| I[services/backtester.py:visualize_equity]
    I -->|График (plotly)| B
    C -->|Результаты| B
    B -->|Отображение| A
```

## 5. API интеграция (Bybit через ccxt)

Интеграция осуществляется через библиотеку [`ccxt`](#). Ключи API (`BYBIT_API_KEY`, `BYBIT_API_SECRET`) считываются из файла [`./.env`](#) с помощью [`python-dotenv`](#) и загружаются в глобальную конфигурацию `config.settings.config`. В [`models/exchange_api.py`](#) создается экземпляр `ccxt.bybit(config)`, где `config` содержит ключи и настройки (тестовая или основная сеть). Параметр `use_testnet` определяет, использовать ли тестовую сеть Bybit (по умолчанию `True`). Для MVP используются только методы получения исторических данных (`fetch_ohlcv`, `fetch_historical_data`), а также симуляция исполнения ордеров (`simulate_order_execution`) для бэктестинга.

## 6. Исправления после ревью

В ходе код-ревью были выявлены и исправлены следующие проблемы, влияющие на архитектуру и логику компонентов:

- **Валидация API ключей только для mainnet** – в `config/settings.py` метод `Config.validate()` теперь проверяет наличие ключей только при `use_testnet=False`. Это позволяет использовать тестовую сеть без указания ключей.

- **Задержка между запросами API** – в `models/exchange_api.py` метод `fetch_historical_data` дополнен `time.sleep(1)` между запросами для соблюдения rate limit биржи. Также улучшена логика остановки цикла загрузки данных.

- **Чередование сторон ордеров в сетке** – в `models/grid_strategy.py` логика распределения сторон изменена с простого разделения по половинам на чередование (чётные уровни – покупка, нечётные – продажа). Это делает стратегию более соответствующей классической сетке.

- **Правильный расчёт Win Rate** – в `services/backtester.py` реализован расчёт Win Rate на основе сопоставления покупок и продаж по методу FIFO, что устраняет заглушку `win_rate = 0.5`.

- **Исправление расчёта Sharpe Ratio** – в том же модуле исправлен annualization factor: используется `sqrt(252)` для торговых дней после ресемплинга equity curve до дневных данных.

- **Кэширование данных в Streamlit** – в `web_ui/app.py` добавлено кэширование загруженных данных в `st.session_state`, что исключает повторную загрузку при каждом нажатии кнопки.

- **Всегда отображаемая статистика данных** – раздел «Статистика данных» в боковой панели теперь всегда виден, даже если данные ещё не загружены.

Эти исправления не изменили сигнатуры публичных методов, но повлияли на внутреннюю логику компонентов. Подробности каждого исправления с указанием файлов и строк приведены в [FIXES.md](FIXES.md).

## 7. План разработки (MVP v1.0)

Данный план будет детализирован в виде [`TODO list`](#) для последующей реализации.

1.  **Инициализация проекта**: Создание базовой структуры папок и файлов, настройка [`requirements.txt`](#).
2.  **Настройка окружения**: Реализация загрузки переменных окружения из [`./.env`](#) в `config/settings.py`.
3.  **Интеграция с биржей**: Реализация класса [`ExchangeAPI`](#) для получения исторических данных с Bybit.
4.  **Загрузчик данных**: Реализация [`data_loader.py`](#) для загрузки и преобразования данных в [`pandas.DataFrame`](#).
5.  **Логика стратегии**: Реализация класса [`GridStrategy`](#) для расчета фиксированных уровней.
6.  **Движок бэктестинга**: Реализация `Backtester` с циклом симуляции и расчетом метрик (PnL, Drawdown).
7.  **Веб-интерфейс (Базовый)**: Создание [`web_ui/app.py`](#) с формой ввода основных параметров (bounds, levels, volume).
8.  **Отображение результатов**: Интеграция вывода таблицы результатов в UI.
9.  **Визуализация**: Добавление графика [`equity curve`](#) с помощью [`plotly`](#).
10. **Экспорт данных**: Реализация функции экспорта результатов в CSV.
11. **Финализация**: Сборка проекта и подтверждение соответствия [`ARCHITECTURE.md`](#).
# Исправление логики определения стороны ордеров в Grid стратегии

## Проблема
В ходе бэктестинга обнаружена критическая ошибка: все 11 сделок были только BUY, отсутствовали SELL сделки. Это происходило из-за неправильной логики определения стороны ордера (`side`) в методе `calculate_levels()` класса `GridStrategy`.

**Неправильная логика до исправления:**
```python
side = "buy" if i % 2 == 0 else "sell"
```
Такая реализация назначала стороны ордеров по чередованию индексов (чётные – покупка, нечётные – продажа) независимо от текущей рыночной цены. В результате сетка могла содержать неадекватное распределение buy/sell ордеров относительно текущей цены, что приводило к отсутствию sell сделок в бэктестинге.

## Правильная логика
В классической grid-стратегии сторона ордера определяется относительно текущей цены:
- Уровни **ниже** текущей цены → `side = "buy"` (покупаем дешевле)
- Уровни **выше** текущей цены → `side = "sell"` (продаём дороже)

## Внесённые изменения

### 1. Модификация метода `calculate_levels()` (файл `models/grid_strategy.py`)
Логика определения стороны заменена на сравнение цены уровня с текущей ценой:
```python
if current_price is None:
    # Если цена не передана, используем среднюю цену между границами
    current_price = (self.lower_bound + self.upper_bound) / 2
    logger.warning(
        f"current_price не передан, используется средняя цена {current_price:.2f}"
    )

for i in range(self.num_levels):
    price = self.lower_bound + i * step
    # Уровни НИЖЕ текущей цены -> buy (покупаем дешевле)
    # Уровни ВЫШЕ текущей цены -> sell (продаём дороже)
    side = "buy" if price < current_price else "sell"
```

### 2. Гарантия передачи `current_price` во всех вызовах
- В `services/backtester.py` уже передавалась средняя цена (`avg_price`), изменений не потребовалось.
- В модульных тестах (`test_grid_strategy.py`) все вызовы `calculate_levels()` теперь явно передают `current_price` (в большинстве случаев `45000.0`).
- Если `current_price` не передан, метод использует среднюю цену между границами и выводит предупреждение в лог.

### 3. Обновление модульных тестов
Поскольку изменилась логика распределения сторон, ожидания в тестах были скорректированы:
- `test_calculate_levels`: проверяет, что при `current_price=45000` уровни `[40000, 42500]` – buy, а `[45000, 47500, 50000]` – sell.
- `test_check_order_execution`: теперь ожидает исполнения двух buy ордеров (40000 и 42500) при цене 39000 и одного sell ордера (47500) при цене 48000.
- `test_statistics` и `test_reset`: обновлены ожидаемые количества исполненных ордеров (2 вместо 1).

## Результат
После исправления:
- Сетка ордеров строится относительно текущей рыночной цены, что соответствует логике grid-трейдинга.
- В бэктестинге будут генерироваться как BUY, так и SELL сделки, что исправит критическую ошибку.
- Все модульные тесты проходят успешно.

## Проверка
Запуск тестов:
```bash
pytest test_grid_strategy.py -v
```
Результат: **6 passed**.

## Рекомендации
- При использовании `GridStrategy` всегда передавайте актуальную `current_price` в метод `calculate_levels()` для корректного определения сторон.
- Убедитесь, что в бэктестинге используется средняя цена исторических данных (как уже реализовано в `services/backtester.py`).
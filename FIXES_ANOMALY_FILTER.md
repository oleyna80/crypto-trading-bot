# Фильтрация аномальных свечей в методе fetch_historical_data

## Описание изменений

В файле `models/exchange_api.py` в методе `fetch_historical_data` добавлена фильтрация аномальных свечей по цене закрытия **перед созданием DataFrame**.

### Что было изменено

1. Удалён блок фильтрации, который выполнялся после создания DataFrame (строки 184–198 в предыдущей версии).
2. Добавлен новый блок фильтрации непосредственно после загрузки всех свечей (`all_ohlcv`) и перед построением `pd.DataFrame` (строки 178–194 в новой версии).
3. Логирование обновлено в соответствии с требованиями:
   - Используется `logger.warning`, если были отфильтрованы свечи.
   - Добавлено информационное сообщение с итоговым количеством корректных свечей.

### Причина изменений

Фильтрация на уровне списка свечей (`list[list[float]]`) более эффективна и соответствует требованию «отфильтровать аномальные свечи после загрузки всех данных и перед возвратом DataFrame». Это также гарантирует, что в DataFrame попадут только валидные данные, что упрощает последующую обработку и снижает риск ошибок в расчётах.

### Как работает новая фильтрация

1. После завершения цикла загрузки имеем список `all_ohlcv`, где каждый элемент — свеча в формате `[timestamp, open, high, low, close, volume]`.
2. Создаётся новый список `filtered_ohlcv`.
3. Для каждой свечи проверяется цена закрытия (`candle[4]`).
4. Если цена закрытия находится в диапазоне `20 000 ≤ close ≤ 200 000`, свеча добавляется в `filtered_ohlcv`.
5. Подсчитывается количество удалённых свечей: `removed_count = len(all_ohlcv) - len(filtered_ohlcv)`.
6. Если `removed_count > 0`, выводится предупреждение (warning) с указанием количества отфильтрованных и оставшихся свечей.
7. В любом случае выводится информационное сообщение с итоговым количеством корректных свечей.
8. DataFrame строится исключительно на основе `filtered_ohlcv`.

### Пример логирования

```
INFO:exchange_api:Загрузка завершена. Всего загружено 1250 свечей
WARNING:exchange_api:Отфильтровано 3 свечей с аномальными ценами (осталось 1247 свечей)
INFO:exchange_api:Количество корректных свечей после фильтрации: 1247
```

Если аномальных цен нет:

```
INFO:exchange_api:Загрузка завершена. Всего загружено 980 свечей
DEBUG:exchange_api:Аномальные цены не обнаружены
INFO:exchange_api:Количество корректных свечей после фильтрации: 980
```

### Проверка корректности

- Диапазон цен соответствует требованиям (20 000 – 200 000).
- Фильтрация выполняется до создания DataFrame, что исключает попадание аномальных значений в последующие вычисления.
- Все необходимые логи сохранены и дополнены.

### Файлы

- `models/exchange_api.py` – изменённый метод `fetch_historical_data`.
- `FIXES_ANOMALY_FILTER.md` – данный файл с описанием.

### Дата изменения

2025-12-17
# Исправление косметических проблем в UI и логах

## Проблемы

### 1. Статистика показывает аномальные цены
В статистике данных отображались экстремальные значения (например, `Диапазон цены: 985.50 - 844444.40`), хотя данные были отфильтрованы (медиана ~104k правильная). Статистика рассчитывалась по нефильтрованному DataFrame, что искажало min/max.

### 2. Неправильный подсчёт buy/sell в результатах
В UI показывалось `Покупки: 0` и `Продажи: 0`, хотя в trades.csv были реальные buy и sell сделки. Это происходило из-за ошибки в методе `calculate_metrics` класса `Backtester`, где переменные `buy_trades` и `sell_trades` не вычислялись.

### 3. Слишком много warnings в логах
Логи засорялись повторяющимися предупреждениями:
```
WARNING:services.backtester:Недостаточно средств для покупки...
WARNING:services.backtester:Недостаточно позиции для продажи...
```
При большом количестве неудачных попыток это создавало шум.

### 4. Предупреждение о недостатке капитала можно улучшить
Существующее предупреждение о превышении общей стоимости покупок над депозитом было недостаточно информативным.

## Внесённые изменения

### Задача 1: Фильтровать аномалии в статистике

**Файл:** `web_ui/app.py`

**Изменения:**
В функции `load_historical_data` добавлена фильтрация аномальных цен перед расчётом статистики. Аномалиями считаются цены вне диапазона 20 000 – 200 000 USDT (типичный диапазон для BTC).

```python
# Фильтрация аномальных цен для статистики (чтобы не искажать min/max)
df_filtered = df[(df['close'] >= 20000) & (df['close'] <= 200000)].copy()
if len(df_filtered) < len(df):
    logger.warning(
        f"Отфильтровано {len(df) - len(df_filtered)} аномалий для статистики "
        f"(цены вне диапазона 20k-200k)"
    )

# Используем отфильтрованные данные для статистики (если они не пустые)
stats_df = df_filtered if not df_filtered.empty else df
st.session_state.data_stats = loader.get_data_statistics(stats_df)
```

**Результат:**
Теперь статистика показывает реалистичный диапазон цен, например:
```
Диапазон цены: 95000.00 - 115000.00
```

### Задача 2: Исправить подсчёт buy/sell в метриках

**Файл:** `services/backtester.py`

**Изменения:**
В методе `calculate_metrics` добавлен явный подсчёт количества покупок и продаж на основе столбца `side` в trades_df.

```python
# Подсчёт buy и sell сделок
buy_trades = 0
sell_trades = 0
if not trades_df.empty and 'side' in trades_df.columns:
    buy_trades = len(trades_df[trades_df['side'] == 'buy'])
    sell_trades = len(trades_df[trades_df['side'] == 'sell'])

metrics = {
    ...
    "buy_trades": buy_trades,
    "sell_trades": sell_trades,
    ...
}
```

**Результат:**
Теперь UI корректно отображает количество покупок и продаж:
```
Покупки: 25
Продажи: 15
```

### Задача 3: Уменьшить количество warnings в логах

**Файл:** `services/backtester.py`

**Изменения:**
Вместо вывода warning для каждой неудачной попытки покупки/продажи введены счётчики `insufficient_funds_count` и `insufficient_position_count`. После завершения цикла по свечам выводится одно итоговое предупреждение для каждого типа.

```python
# Счётчики для группирования warnings
insufficient_funds_count = 0
insufficient_position_count = 0

# В цикле при недостатке средств/позиции:
if level.side == "buy":
    ...
    if balance >= cost + fee:
        ...
    else:
        insufficient_funds_count += 1
        continue
else:  # sell
    if position >= level.volume:
        ...
    else:
        insufficient_position_count += 1
        continue

# После цикла:
if insufficient_funds_count > 0:
    logger.warning(f"Пропущено {insufficient_funds_count} покупок из-за недостатка средств")
if insufficient_position_count > 0:
    logger.warning(f"Пропущено {insufficient_position_count} продаж из-за отсутствия позиции")
```

**Результат:**
Логи стали чище:
```
WARNING:services.backtester:Пропущено 29 покупок из-за недостатка средств
WARNING:services.backtester:Пропущено 30 продаж из-за отсутствия позиции
```

### Задача 4: Добавить предупреждение о недостатке капитала

**Файл:** `models/grid_strategy.py`

**Изменения:**
Улучшено существующее предупреждение о превышении общей стоимости покупок над депозитом. Добавлен расчёт дефицита и рекомендация.

```python
total_buy_cost = self.amount_per_level * self.num_levels * self.lower_bound
if total_buy_cost > self.deposit:
    deficit = total_buy_cost - self.deposit
    logger.warning(
        f"Общая стоимость покупок ({total_buy_cost:.2f} USDT) "
        f"превышает депозит ({self.deposit:.2f} USDT). "
        f"Дефицит: {deficit:.2f} USDT. "
        f"Рекомендуется: уменьшить количество уровней или увеличить депозит."
    )
```

**Результат:**
Пользователь получает более информативное сообщение с конкретным дефицитом и советом по исправлению.

## Проверка

После внесения изменений:

1. **Перезапустить Streamlit:**
```bash
cd /mnt/e/Python_project/bybit_grid_bot && PYTHONPATH=$(pwd) streamlit run web_ui/app.py
```

2. **Очистить кэш** (при необходимости):
```bash
rm cache/*.pkl
```

3. **Загрузить данные** (30-130 дней)

4. **Проверить статистику** – диапазон цен должен быть без аномалий.

5. **Запустить backtesting** – в логах должны быть группированные warnings, а в метриках – корректные buy/sell.

6. **Проверить логи** – меньше повторяющихся сообщений.

## Тестирование

Все существующие тесты проходят успешно:
- `test_backtester.py` – 5 passed
- `test_grid_strategy.py` – 6 passed

Дополнительный скрипт `test_cosmetic.py` подтверждает работоспособность изменений.

## Заключение

Косметические улучшения повышают удобство использования интерфейса и читаемость логов. Пользователь теперь видит корректную статистику данных, правильное количество сделок по сторонам и получает понятные предупреждения о проблемах с капиталом и исполнением ордеров.